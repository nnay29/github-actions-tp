name: CI - Linting & Type Checking

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    branches: [ main ]
  
jobs:
  lint_and_build:
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      contents: write # N√©cessaire pour l'acc√®s aux secrets et au contenu
    
    steps:
    - name: ‚¨áÔ∏è Checkout code
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*' 

    - name: üì¶ Install dependencies
      run: npm ci

    # --- √âtape 1: Linting et Rapport JSON ---
    - name: üîç Run ESLint (Generate Report)
      id: linter_report
      # Suppose que "npm run lint:ci" cr√©e eslint_report.json || true
      run: npm run lint:ci 

    - name: üî® Run TypeScript Build Check
      run: npm run build
      
    # --- √âtape 2: R√©troaction IA Dynamique ---
# --- √âtape 2: R√©troaction IA Dynamique (Correction Finale du D√©bogage) ---
    - name: ü§ñ Post Dynamic AI Feedback on Failure
      id: ai_review_step
      if: github.event_name == 'pull_request' && (success() || failure())
      
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        OWNER: ${{ github.repository_owner }}
        REPO: ${{ github.event.repository.name }}
        
      run: |
        # 1. V√©rification du rapport
        # ... (code identique) ...

        # 2. Pr√©paration du prompt pour l'IA
        LINT_ERRORS=$(cat eslint_report.json)
        
        PROMPT="Tu es un relecteur de code expert en React et TypeScript. Le pipeline CI/CD vient d'√©chouer. Analyse ce rapport ESLint en JSON. 
        1. Fournis une critique concise, en fran√ßais, en soulignant la cause principale de l'√©chec.
        2. Inclue dans ta r√©ponse un lien vers une ressource YouTube ou un article qui explique comment corriger cette erreur. La r√©ponse doit √™tre format√©e en Markdown.
        Rapport ESLint:\n$LINT_ERRORS"
        
        # √âchappement pour JSON
        ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs '{"text":.} | .text' | tr -d '\n' | sed 's/"/\\"/g' )
        
        # 3. Appel √† l'API Gemini (AVEC D√âBOGAGE)
        echo "Ex√©cution de l'appel API..."
        API_RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent" \
          -H "Content-Type: application/json" \
          -H "x-goog-api-key: $GEMINI_API_KEY" \
          -d '{
            "contents": [
              {
                "parts": [
                  {
                    "text": "'"$ESCAPED_PROMPT"'"
                  }
                ]
              }
            ]
          }')
          
        # üö® AJOUT DE LA LIGNE DE D√âBOGAGE CRUCIALE
        echo "R√©ponse API brute re√ßue (V√©rifiez les erreurs 400 ou 500) :"
        echo "--------------------------------------------------------"
        echo "$API_RESPONSE"
        echo "--------------------------------------------------------"
          
        # 4. Extraction du texte de l'IA (Utilisation d'une variable de secours si l'extraction √©choue)
        GEMINI_TEXT=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text' 2>/dev/null)
        
        # üö® V√âRIFICATION ET REMPLACEMENT EN CAS DE NULL
        if [ -z "$GEMINI_TEXT" ]; then
            GEMINI_TEXT="**ERREUR : La revue de l'IA n'a pas pu √™tre g√©n√©r√©e.** Le service a probablement retourn√© une erreur (v√©rifiez les logs ci-dessus) ou le chemin d'extraction JSON a √©chou√©. **Veuillez v√©rifier que la cl√© API Gemini est valide.**\n\n**Rapport brut (JSON) :**\n$API_RESPONSE"
        fi

        # 5. Stockage et publication du commentaire (le reste est identique)
        echo "ai_review<<EOF_AI_REVIEW_OUTPUT" >> $GITHUB_OUTPUT
        echo "$GEMINI_TEXT" >> $GITHUB_OUTPUT
        echo "EOF_AI_REVIEW_OUTPUT" >> $GITHUB_OUTPUT
        
        # ... (le reste du code pour le commentaire GitHub reste identique) ...     
    # --- √âtape 3: NOTIFICATION EMAIL EN CAS D'√âCHEC ---
    - name: üìß Send Failure Email Notification √† l'√©quipe et l'auteur
      # Se d√©clenche si Build ou Type Check √©choue
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{secrets.MAIL_USERNAME}}
        password: ${{secrets.MAIL_PASSWORD}} 
        
        subject: '√âCHEC CI/CD pour PR #${{ github.event.pull_request.number }} par @${{ github.actor }}'
        
        body: |
          Bonjour @${{ github.event.pull_request.user.login }},
          
          Votre Pull Request #${{ github.event.pull_request.number }} a √©chou√© au pipeline CI/CD (Build/Type Check/Linting).
          
          ---
          
          ## ü§ñ Revue de l'Assistant IA (Gemini)
          
          ${{ steps.ai_review_step.outputs.ai_review }}
          
          ---
          
          Veuillez consulter les logs GitHub Actions pour les d√©tails exacts de l'erreur ou le lien de la PR pour le commentaire: ${{ github.event.pull_request.html_url }}.
        
        to: ${{ secrets.TEAM_EMAIL_RECIPIENT }} 
        from: ${{ secrets.MAIL_USERNAME }}