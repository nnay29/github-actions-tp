name: CI - Linting & Type Checking

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    branches: [main]
  
jobs:
  lint_and_build:
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      contents: write
    
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîç Run ESLint (Generate Report)
        id: linter_report
        run: npm run lint:ci || true

      - name: üî® Run TypeScript Build Check
        run: npm run build
      
      - name: ü§ñ Post Dynamic AI Feedback on Failure
        id: ai_review_step
        if: github.event_name == 'pull_request' && (success() || failure())
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          if [ ! -s eslint_report.json ]; then
            echo "ESLint report file is vide ou n'existe pas. Aucune erreur trouv√©e."
            echo "ai_review<<EOF_AI_REVIEW_OUTPUT" >> $GITHUB_OUTPUT
            echo "Aucune erreur de Linting trouv√©e. ‚úÖ" >> $GITHUB_OUTPUT
            echo "EOF_AI_REVIEW_OUTPUT" >> $GITHUB_OUTPUT
            exit 0
          fi

          LINT_ERRORS=$(cat eslint_report.json)
          
          PROMPT="Tu es un relecteur de code expert en React et TypeScript. Le pipeline CI/CD vient d'√©chouer. Analyse ce rapport ESLint en JSON. 
          1. Fournis une critique concise, en fran√ßais, en soulignant les erreurs de variable non utilis√©e et la violation de la r√®gle 'Love Component'.
          2. Inclue un lien vers une ressource YouTube ou un article sur la correction des erreurs de nommage (PascalCase/regex).
          3. Assure-toi que la r√©ponse est en Markdown.
          
          Rapport ESLint:\n$LINT_ERRORS"
          
          echo "$PROMPT" > prompt.txt
          
          API_RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent" \
            -H "Content-Type: application/json" \
            -H "x-goog-api-key: $GEMINI_API_KEY" \
            -d @- << EOF_DATA
          {
            "contents": [
              {
                "parts": [
                  {
                    "text": "$(cat prompt.txt)"
                  }
                ]
              }
            ]
          }
          EOF_DATA
          )
            
          echo "R√©ponse API brute re√ßue (V√©rifiez les erreurs 400 ou 500) :"
          echo "--------------------------------------------------------"
          echo "$API_RESPONSE"
          echo "--------------------------------------------------------"
            
          GEMINI_TEXT=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text' 2>/dev/null)
          
          if [ -z "$GEMINI_TEXT" ]; then
              GEMINI_TEXT="**ERREUR : La revue IA a √©chou√©.** Cause probable : formatage JSON ou mauvaise cl√©. **R√©ponse API brute :**\n\n$API_RESPONSE"
          fi

          echo "ai_review<<EOF_AI_REVIEW_OUTPUT" >> $GITHUB_OUTPUT
          echo "$GEMINI_TEXT" >> $GITHUB_OUTPUT
          echo "EOF_AI_REVIEW_OUTPUT" >> $GITHUB_OUTPUT
          
          COMMENT_BODY="## ü§ñ Revue de Code (Aliment√© par Gemini) üíñ\n\n$GEMINI_TEXT\n\n---\n\n_R√®gle 'Love Component' : Composants en PascalCase, suffixe 'Love'._"
          
          cat << EOF_COMMENT_PAYLOAD > comment_payload.json
          {
            "body": "$COMMENT_BODY"
          }
          EOF_COMMENT_PAYLOAD
          
          curl -s -X POST "https://api.github.com/repos/$OWNER/$REPO/issues/$PR_NUMBER/comments" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data-binary "@comment_payload.json"
            
      - name: üìß Send Failure Email Notification √† l'√©quipe et l'auteur
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: '√âCHEC CI/CD pour PR #${{ github.event.pull_request.number }} par @${{ github.actor }}'
          body: |
            Bonjour @${{ github.event.pull_request.user.login }},
            
            Votre Pull Request #${{ github.event.pull_request.number }} a √©chou√© au pipeline CI/CD (Build/Type Check/Linting).
            
            ---
            
            ## ü§ñ Revue de l'Assistant IA (Gemini)
            
            ${{ steps.ai_review_step.outputs.ai_review }}
            
            ---
            
            Veuillez consulter les logs GitHub Actions pour les d√©tails exacts de l'erreur ou le lien de la PR pour le commentaire: ${{ github.event.pull_request.html_url }}.
          to: ${{ secrets.TEAM_EMAIL_RECIPIENT }}
          from: ${{ secrets.MAIL_USERNAME }}