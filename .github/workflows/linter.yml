name: CI - Linting & Type Checking

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    branches: [ main ]
  
jobs:
  lint_and_build:
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      contents: write # N√©cessaire pour l'acc√®s aux secrets et au contenu
    
    steps:
    - name: ‚¨áÔ∏è Checkout code
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*' 

    - name: üì¶ Install dependencies
      run: npm ci

    # --- √âtape 1: Linting et Rapport JSON ---
    - name: üîç Run ESLint (Generate Report)
      id: linter_report
      # Suppose que "npm run lint:ci" cr√©e eslint_report.json || true
      run: npm run lint:ci 

    - name: üî® Run TypeScript Build Check
      run: npm run build
      
    # --- √âtape 2: R√©troaction IA Dynamique ---
# --- √âtape 2: R√©troaction IA Dynamique (Correction Finale du D√©bogage) ---
    - name: ü§ñ Post Dynamic AI Feedback on Failure
      id: ai_review_step
      if: github.event_name == 'pull_request' && (success() || failure())
      
      env:
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        OWNER: ${{ github.repository_owner }}
        REPO: ${{ github.event.repository.name }}
        
      run: |
        # 1. V√©rification du rapport d'erreurs
        if [ ! -s eslint_report.json ]; then
          echo "ESLint report file is vide ou n'existe pas. Aucune erreur trouv√©e."
          echo "ai_review<<EOF_AI_REVIEW_OUTPUT" >> $GITHUB_OUTPUT
          echo "Aucune erreur de Linting trouv√©e. ‚úÖ" >> $GITHUB_OUTPUT
          echo "EOF_AI_REVIEW_OUTPUT" >> $GITHUB_OUTPUT
          exit 0
        fi

        # 2. Pr√©paration du prompt pour l'IA
        LINT_ERRORS=$(cat eslint_report.json)
        
        PROMPT="Tu es un relecteur de code expert en React et TypeScript. Le pipeline CI/CD vient d'√©chouer. Analyse ce rapport ESLint en JSON. 
        1. Fournis une critique concise, en fran√ßais, en soulignant la cause principale de l'√©chec.
        2. Inclue dans ta r√©ponse un lien vers une ressource YouTube ou un article qui explique comment corriger cette erreur. La r√©ponse doit √™tre format√©e en Markdown.
        Rapport ESLint: $LINT_ERRORS"
        
        # 3. Appel √† l'API avec mod√®le gratuit fiable
        echo "Ex√©cution de l'appel API..."
        API_RESPONSE=$(curl -s -X POST "https://openrouter.ai/api/v1/chat/completions" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $OPENROUTER_API_KEY" \
          -d "{
            \"model\": \"meta-llama/llama-3.2-3b-instruct:free\",
            \"messages\": [
              {
                \"role\": \"user\",
                \"content\": $(echo "$PROMPT" | jq -Rs .)
              }
            ]
          }")
          
        echo "R√©ponse API brute re√ßue :"
        echo "--------------------------------------------------------"
        echo "$API_RESPONSE"
        echo "--------------------------------------------------------"
          
        # 4. Extraction du texte de l'IA
        AI_TEXT=$(echo "$API_RESPONSE" | jq -r '.choices[0].message.content' 2>/dev/null)
        
        # V√©rification des erreurs et fallback
        if [ -z "$AI_TEXT" ] || [ "$AI_TEXT" = "null" ]; then
            # V√©rifier si c'est une erreur de rate limit
            ERROR_MSG=$(echo "$API_RESPONSE" | jq -r '.error.message' 2>/dev/null)
            if [[ "$ERROR_MSG" == *"rate-limited"* ]]; then
                AI_TEXT="## ‚ö†Ô∏è Analyse du Code\n\n**Erreurs d√©tect√©es dans le rapport ESLint :**\n\nLe pipeline a √©chou√© √† cause d'erreurs de linting. Consultez le rapport ESLint ci-dessus pour les d√©tails.\n\n**Ressources utiles :**\n- [Guide ESLint React](https://eslint.org/docs/rules/)\n- [TypeScript Best Practices](https://typescript-eslint.io/rules/)"
            else
                AI_TEXT="**ERREUR API :** $ERROR_MSG. **Rapport brut :** $API_RESPONSE"
            fi
        fi

        # 5. Stockage pour l'email
        echo "ai_review<<EOF_AI_REVIEW_OUTPUT" >> $GITHUB_OUTPUT
        echo "$AI_TEXT" >> $GITHUB_OUTPUT
        echo "EOF_AI_REVIEW_OUTPUT" >> $GITHUB_OUTPUT
        
        # 6. Publication du commentaire sur la PR
        COMMENT_BODY="## ü§ñ Revue de Code IA üíñ\n\n$AI_TEXT\n\n---\n\n_R√®gle 'Love Component' : Composants en PascalCase, suffixe 'Love'._"
        
        curl -s -X POST "https://api.github.com/repos/$OWNER/$REPO/issues/$PR_NUMBER/comments" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"body\": $(echo "$COMMENT_BODY" | jq -Rs .)
          }"     
    # --- √âtape 3: NOTIFICATION EMAIL EN CAS D'√âCHEC ---
    - name: üìß Send Failure Email Notification √† l'√©quipe et l'auteur
      # Se d√©clenche si Build ou Type Check √©choue
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{secrets.MAIL_USERNAME}}
        password: ${{secrets.MAIL_PASSWORD}} 
        
        subject: '√âCHEC CI/CD pour PR #${{ github.event.pull_request.number }} par @${{ github.actor }}'
        
        body: |
          Bonjour @${{ github.event.pull_request.user.login }},
          
          Votre Pull Request #${{ github.event.pull_request.number }} a √©chou√© au pipeline CI/CD (Build/Type Check/Linting).
          
          ---
          
          ## ü§ñ Revue de l'Assistant IA (DeepSeek R1)
          
          ${{ steps.ai_review_step.outputs.ai_review }}
          
          ---
          
          Veuillez consulter les logs GitHub Actions pour les d√©tails exacts de l'erreur ou le lien de la PR pour le commentaire: ${{ github.event.pull_request.html_url }}.
        
        to: ${{ secrets.TEAM_EMAIL_RECIPIENT }} 
        from: ${{ secrets.MAIL_USERNAME }}