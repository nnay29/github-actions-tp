name: CI - Linting & Type Checking

on:
  pull_request:
    # Only run on opened, synchronized (new commit), or ready_for_review events
    types: [opened, synchronize, ready_for_review]
    branches: [ main ]
  
jobs:
  lint_and_build:
    runs-on: ubuntu-latest
    
    # Define permissions needed for GITHUB_TOKEN to post comments
    permissions:
      pull-requests: write
      contents: read
    
    steps:
    - name: ‚¨áÔ∏è Checkout code
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*' 

    - name: üì¶ Install dependencies
      run: npm ci

    # --- LINTING STEP ---
    - name: üîç Run ESLint (Generate Report)
      id: linter_report
      # Use the CI script from package.json: saves report, forces exit code 0
      run: npm run lint:ci
      
    # --- BUILD CHECK STEP ---
    - name: üî® Run TypeScript Build Check
      run: npm run build
      
    # --- DYNAMIC AI FEEDBACK (ONLY ON LINTING FAILURE) ---
    - name: ü§ñ Post Dynamic AI Feedback on Failure
      #
      
      if: github.event_name == 'pull_request' && (success() || failure())
      
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        OWNER: ${{ github.repository_owner }}
        REPO: ${{ github.event.repository.name }}
        
      run: |
        # 1. Check if the generated JSON report is empty (no linting errors).
        # We rely on the report having been generated by 'npm run lint:ci'
        if [ ! -s eslint_report.json ]; then
          echo "ESLint report file is empty or does not exist. No errors found."
          exit 0
        fi

        # 2. Extract the content of the ESLint report file.
        LINT_ERRORS=$(cat eslint_report.json)
        
        # 3. Construct the prompt for the Gemini API.
        # This prompt tells Gemini its role and provides the error data.
        PROMPT="You are a strict, yet helpful, code quality reviewer bot. Your primary rule is to enforce the 'Love Component' standard: all functional components must be named in PascalCase and end with the suffix 'Love'. Analyze the following ESLint report in JSON format. Generate a friendly but firm response, highlighting the 'Love Component' rule violation and suggesting fixes. Keep the response concise and use Markdown for formatting. \n\nESLint Report:\n$LINT_ERRORS"
        
        # 4. Escape the prompt for safe JSON embedding (crucial for curl).
        ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs '{"prompt":.} | .prompt' | tr -d '\n')
        
        # 5. Call the Gemini API using curl.
        # The API key is passed securely via the HTTP header.
        API_RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent" \
          -H "Content-Type: application/json" \
          -H "x-goog-api-key: $GEMINI_API_KEY" \
          -d '{
            "contents": [
              {
                "parts": [
                  {
                    "text": '"$ESCAPED_PROMPT"'
                  }
                ]
              }
            ]
          }')
          
        # 6. Extract the generated text from the JSON response.
        GEMINI_TEXT=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text')
        
        # 7. Format the final comment body.
        COMMENT_BODY="## ü§ñ Code Review Bot (Powered avec Gemini) üíñ\n\n$GEMINI_TEXT\n\n---\n\n_Rule check: All functional components must be named in **PascalCase** and end with the suffix **Love** (e.g., `HeaderLove`)._"
        
        # 8. Post the comment back to the Pull Request using the GitHub API (via curl).
        curl -s -X POST "https://api.github.com/repos/$OWNER/$REPO/issues/$PR_NUMBER/comments" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{\"body\": \"$COMMENT_BODY\"}"
          
    # --- EMAIL NOTIFICATION STEP (ON ANY FAILURE) ---
    - name: üìß Send Failure Email Notification
      # This step only runs IF the overall job fails (due to build or type-checking)
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{secrets.MAIL_USERNAME}}
        password: ${{secrets.MAIL_PASSWORD}} # This is your Gmail App Password
        subject: 'CI/CD FAILURE in ${{ github.repository }} PR #${{ github.event.pull_request.number }}'
        body: |
          Hello Team,
          
          The Pull Request #${{ github.event.pull_request.number }} by ${{ github.event.pull_request.user.login }} has failed the CI/CD pipeline (Linting/Build/Type Check).
          
          **Repository:** ${{ github.repository }}
          **Link:** ${{ github.event.pull_request.html_url }}
          
          Please review the GitHub Actions logs for the exact error details.
        to: ${{ secrets.TEAM_EMAIL_RECIPIENT }} # Comma-separated list of team emails
        from: ${{ secrets.MAIL_USERNAME }}